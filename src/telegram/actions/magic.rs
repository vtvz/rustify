use futures::StreamExt;
use indoc::formatdoc;
use rand::seq::SliceRandom;
use rspotify::model::{Id, UserId};
use rspotify::prelude::{BaseClient as _, OAuthClient as _};
use sea_orm::prelude::Expr;
use sea_orm::{ColumnTrait, EntityTrait, QueryFilter};
use teloxide::payloads::EditMessageTextSetters;
use teloxide::prelude::Requester;
use teloxide::types::{ChatId, ParseMode};

use crate::app::App;
use crate::entity::prelude::{UserColumn, UserEntity};
use crate::spotify::ShortPlaylist;
use crate::telegram::handlers::HandleStatus;
use crate::user::UserState;

async fn get_playlist(
    state: &UserState,
    user_id: UserId<'static>,
) -> anyhow::Result<ShortPlaylist> {
    let playlist_name = "Rustify Magic Playlist";

    let spotify = state.spotify().await;

    let mut playlists = spotify.user_playlists(user_id.clone());

    while let Some(playlist) = playlists.next().await {
        let playlist = playlist?;
        if playlist.name == playlist_name {
            spotify
                .playlist_replace_items(playlist.id.clone(), [])
                .await?;

            return Ok(playlist.into());
        }
    }

    let playlist = spotify
        .user_playlist_create(
            user_id,
            playlist_name,
            Some(false),
            Some(false),
            Some("Autogenerated Playlist by Rustify Bot"),
        )
        .await?;

    Ok(playlist.into())
}

pub async fn handle(
    app: &'static App,
    state: &UserState,
    chat_id: ChatId,
) -> anyhow::Result<HandleStatus> {
    if !state.is_spotify_authed().await {
        return Ok(HandleStatus::Skipped);
    }

    let Some(spotify_user) = state.spotify_user().await? else {
        return Ok(HandleStatus::Skipped);
    };

    let m = app
        .bot()
        .send_message(chat_id, "‚è≥ Generating Magic Playlist")
        .await?;

    let spotify = state.spotify().await;
    let mut saved_tracks = spotify.current_user_saved_tracks(None);
    let mut track_ids = vec![];
    while let Some(track) = saved_tracks.next().await {
        let track = track?;
        if let Some(track_id) = track.track.id {
            track_ids.push(track_id.into())
        }
    }

    track_ids.shuffle(&mut rand::rng());

    let playlist = get_playlist(state, spotify_user.id).await?;

    UserEntity::update_many()
        .filter(UserColumn::Id.eq(state.user_id()))
        .col_expr(UserColumn::MagicPlaylist, Expr::value(playlist.id.id()))
        .exec(app.db())
        .await?;

    for chunk in track_ids.chunks(100) {
        spotify
            .playlist_add_items(playlist.id.clone(), chunk.iter().cloned(), None)
            .await?;
    }

    app.bot()
        .edit_message_text(
            m.chat.id,
            m.id,
            formatdoc!(
                r#"
                    Created <a href="{}">Magic Playlist</a>
                "#,
                playlist.url
            ),
        )
        .parse_mode(ParseMode::Html)
        .await?;

    Ok(HandleStatus::Handled)
}
